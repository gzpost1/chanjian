<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yjtech.wisdom.tourism.resource.ticket.mapper.TicketCheckMapper">
    <resultMap id="BaseResultMap" type="com.yjtech.wisdom.tourism.resource.ticket.entity.TicketCheckEntity">
        <id column="check_id" property="checkId" jdbcType="BIGINT"/>
        <result column="scenic_name" property="scenicName" jdbcType="VARCHAR"/>
        <result column="scenic_id" property="scenicId" jdbcType="BIGINT"/>
        <result column="check_place" property="checkPlace" jdbcType="VARCHAR"/>
        <result column="check_time" property="checkTime" jdbcType="TIMESTAMP"/>
        <result column="gate_no" property="gateNo" jdbcType="VARCHAR"/>
        <result column="check_num" property="checkNum" jdbcType="INTEGER"/>
        <result column="ticket_no" property="ticketNo" jdbcType="VARCHAR"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="create_user" property="createUser" jdbcType="BIGINT"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="update_user" property="updateUser" jdbcType="BIGINT"/>
        <result column="deleted" property="deleted" jdbcType="TINYINT"/>
    </resultMap>

    <sql id="Base_Column_List">
        check_id, scenic_name,scenic_id, check_place, check_time, gate_no, check_num, ticket_no, create_time,
        create_user, update_time, update_user, deleted
    </sql>

    <select id="queryCheckNumByTime" resultType="java.lang.Integer">
        select IFNULL(sum(tc.check_num),0) check_num from tb_ticket_check tc
        <include refid="scenic_table_join"/>
        <trim prefix="WHERE" prefixOverrides="AND |OR ">
            <include refid="condition_sql_where"/>
        </trim>
    </select>

    <select id="queryPassengerFlowTop5" resultType="com.yjtech.wisdom.tourism.resource.scenic.entity.vo.ScenicBaseVo">
        SELECT
        tc.scenic_id id,
        tc.scenic_name name,
        sum(tc.check_num) `value`
        FROM
        tb_ticket_check tc
        <include refid="scenic_table_join"/>
        <trim prefix="WHERE" prefixOverrides="AND |OR ">
            <include refid="condition_sql_where"/>
        </trim>
        GROUP BY tc.scenic_id
        ORDER BY tc.check_num DESC
    </select>

    <select id="queryCheckTrendByTime" resultType="com.yjtech.wisdom.tourism.resource.ticket.vo.SaleTrendVO">
        SELECT
        <if test="params.type == 2">
            DATE_FORMAT( tc.check_time, '%Y-%m-01' ) `time`,
        </if>
        <if test="params.type == 3">
            DATE_FORMAT( tc.check_time, '%Y-%m-%d' ) `time`,
        </if>
        sum(tc.check_num) visitQuantity
        FROM
        tb_ticket_check tc
        <include refid="scenic_table_join"/>
        <trim prefix="WHERE" prefixOverrides="AND |OR ">
            <include refid="condition_sql_where"/>
        </trim>
        GROUP BY
        <if test="params.type == 2">
            DATE_FORMAT( tc.check_time, '%Y-%m' )
        </if>
        <if test="params.type == 3">
            DATE_FORMAT( tc.check_time, '%Y-%m-%d' )
        </if>
        ORDER BY tc.check_time
    </select>

    <sql id="scenic_table_join">
        INNER JOIN  tb_scenic s on tc.scenic_id = s.id and s.status=1
    </sql>

    <sql id="condition_sql_where">
        <if test="params.beginTime != null and params.endTime != null">
            and (tc.check_time <![CDATA[ >= ]]> #{params.beginTime,jdbcType=TIMESTAMP} AND tc.check_time <![CDATA[ < ]]>
            #{params.endTime,jdbcType=TIMESTAMP})
        </if>
        <if test="params.scenicId != null and params.scenicId != null">
            and tc.scenic_id = #{params.scenicId,jdbcType=BIGINT}
        </if>
        and tc.deleted = 0
    </sql>

</mapper>
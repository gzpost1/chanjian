<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yjtech.wisdom.tourism.resource.video.mapper.TbVideoMapper">


    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.yjtech.wisdom.tourism.resource.video.entity.TbVideoEntity">
        <id column="id" property="id"/>
        <result column="device_id" property="deviceId"/>
        <result column="name" property="name"/>
        <result column="location" property="location"/>
        <result column="longitude" property="longitude"/>
        <result column="secenic_id" property="secenicId"/>
        <result column="secenic_name" property="secenicName"/>
        <result column="latitude" property="latitude"/>
        <result column="url" property="url"/>
        <result column="sort" property="sort"/>
        <result column="create_time" property="createTime"/>
        <result column="create_user" property="createUser"/>
        <result column="update_time" property="updateTime"/>
        <result column="update_user" property="updateUser"/>
        <result column="deleted" property="deleted"/>
        <result column="status" property="status"/>
        <result column="address" property="address"/>
        <result column="equip_status" property="equipStatus"/>
        <association property="scenic" column="secenic_id"
                     select="com.yjtech.wisdom.tourism.resource.video.mapper.TbVideoMapper.querySecenicInfoById"
        />
    </resultMap>

    <select id="querySecenicInfoById" resultType="com.yjtech.wisdom.tourism.resource.scenic.entity.ScenicEntity">
        select name,emergency_contact,emergency_contact_phone from tb_scenic where id=#{secenicId}
    </select>


    <select id="list" resultMap="BaseResultMap"
            parameterType="com.yjtech.wisdom.tourism.resource.video.entity.TbVideoEntity">
        select
        <include refid="Base_Column_List"/>
        from tb_video v left join tb_scenic s on v.secenic_id=s.id
        <where>
            <include refid="dynamic_where"/>
        </where>
        order by equip_status desc,sort
    </select>

    <!-- 查询大屏综合总览监控列表 -->
    <select id="queryScreenVideoList" resultType="com.yjtech.wisdom.tourism.resource.video.dto.ScreenVideoListDTO"
            parameterType="com.yjtech.wisdom.tourism.resource.video.vo.ScreenVideoQueryVO">
        select
        video.id as videoId,
        scenic.id as scenicId,
        video.name as videoName,
        video.url as url,
        scenic.name as scenicName,
        scenic.emergency_contact as emergencyContact,
        scenic.emergency_contact_phone as emergencyContactPhone
        from
        tb_video video
        INNER JOIN tb_scenic scenic ON video.secenic_id = scenic.id
        <if test="params != null and params.status != null">
            and scenic.status = #{params.status}
        </if>
        <where>
            <if test="params != null">
                <if test="params.status != null">
                    video.status = #{params.status} and
                </if>
                <if test="params.equipStatus != null">
                    video.equip_status = #{params.equipStatus} and
                </if>
            </if>
            video.deleted = 0 and
            scenic.deleted = 0
        </where>
        ORDER BY video.sort, video.create_time DESC
        LIMIT 6
    </select>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        v.id, v.device_id, v.name, v.location, v.longitude, v.secenic_id, v.secenic_name, v.latitude, v.url, v.sort, v.create_time, v.create_user, v.update_time, v.update_user, v.deleted, v.status, v.address, v.equip_status,s.name secenic_name
    </sql>

    <sql id="dynamic_where">
        <if test="params!=null">
            <if test=" params.id != null">
                and v.id = #{params.id}
            </if>
            <if test=" params.deviceId != null and params.deviceId.trim() != ''">
                and v.device_id like CONCAT('%','${params.deviceId}','%' )
            </if>
            <if test=" params.name != null and params.name.trim() != ''">
                and v.name like CONCAT('%','${params.name}','%' )
            </if>
            <if test=" params.location != null and params.location.trim() != ''">
                and v.location like CONCAT('%','${params.location}','%' )
            </if>
            <if test=" params.longitude != null and params.longitude.trim() != ''">
                and v.longitude like CONCAT('%','${params.longitude}','%' )
            </if>
            <if test=" params.secenicId != null">
                and v.secenic_id = #{params.secenicId}
            </if>
            <if test=" params.secenicName != null and params.secenicName.trim() != ''">
                and s.name like CONCAT('%','${params.secenicName}','%' )
            </if>
            <if test=" params.latitude != null and params.latitude.trim() != ''">
                and v.latitude like CONCAT('%','${params.latitude}','%' )
            </if>
            <if test=" params.url != null and params.url.trim() != ''">
                and v.url like CONCAT('%','${params.url}','%' )
            </if>
            <if test=" params.sort != null">
                and v.sort = #{params.sort}
            </if>
            <if test=" params.createTime != null">
                <!--  and  create_time between #{params.beginDate} and #{params.endDate}  -->
                and v.create_time = #{params.createTime}
            </if>
            <if test=" params.createUser != null">
                and v.create_user = #{params.createUser}
            </if>
            <if test=" params.updateTime != null">
                <!--  and  update_time between #{params.beginDate} and #{params.endDate}  -->
                and v.update_time = #{params.updateTime}
            </if>
            <if test=" params.updateUser != null">
                and v.update_user = #{params.updateUser}
            </if>
            <if test=" params.deleted != null">
                and v.deleted = #{params.deleted}
            </if>
            <if test=" params.status != null">
                and v.status = #{params.status}
            </if>
            <if test=" params.address != null and params.address.trim() != ''">
                and v.address like CONCAT('%','${params.address}','%' )
            </if>
            <if test=" params.equipStatus != null">
                and v.equip_status = #{params.equipStatus}
            </if>
        </if>
    </sql>

</mapper>
